Improve extras dependency handling (#3878)
